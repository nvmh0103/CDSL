CREATE DATABASE DE1MOI
USE DE1MOI
CREATE TABLE TACGIA(
    MATG CHAR(5) PRIMARY KEY,
    HOTEN VARCHAR(20),
    DIACHI VARCHAR(50),
    NGSINH SMALLDATETIME,
    SODT VARCHAR(15)
)
CREATE TABLE SACH(
    MASACH CHAR(5) PRIMARY KEY,
    TENSACH VARCHAR(25),
    THELOAI VARCHAR(25)
)
CREATE TABLE TACGIA_SACH(
    MATG CHAR(5),
    MASACH CHAR(5),
    CONSTRAINT PK_TGS PRIMARY KEY (MATG,MASACH),
    CONSTRAINT FK_MATG FOREIGN KEY (MATG) REFERENCES TACGIA(MATG),
    CONSTRAINT FK_MASACH FOREIGN KEY (MASACH) REFERENCES SACH(MASACH)


)
CREATE TABLE PHATHANH(
    MAPH CHAR(5) PRIMARY KEY,
    MASACH CHAR(5),
    NGAYPH SMALLDATETIME,
    SOLUONG INT,
    NHAXUATBAN VARCHAR(20)
)
ALTER TABLE PHATHANH 
ADD CONSTRAINT FK_PH FOREIGN KEY (MASACH) REFERENCES SACH(MASACH)

-- NHAP
USE DE1MOI
SET DATEFORMAT DMY
INSERT INTO TACGIA(MATG,HOTEN,DIACHI,NGSINH,SODT) VALUES ('TG01','PHAM THANH BINH','123/4 CAO CHUONG','15/04/1993','0902444222')
INSERT INTO TACGIA(MATG,HOTEN,DIACHI,NGSINH,SODT) VALUES ('TG02','PHAM THANH THAO','133/4 CAO CHUONG','16/04/1993','0902444223')
INSERT INTO TACGIA(MATG,HOTEN,DIACHI,NGSINH,SODT) VALUES ('TG03','PHAM THANH ACH','134/4 CAO CHUONG','17/04/1993','0902444224')
INSERT INTO TACGIA(MATG,HOTEN,DIACHI,NGSINH,SODT) VALUES ('TG04','PHAM THANH NEV','135/4 CAO CHUONG','18/04/1993','0902444252')
INSERT INTO TACGIA(MATG,HOTEN,DIACHI,NGSINH,SODT) VALUES ('TG05','PHAM THANH BAO','149/4 CAO CHUONG','19/04/1993','0902444226')
INSERT INTO TACGIA(MATG,HOTEN,DIACHI,NGSINH,SODT) VALUES ('TG06','PHAM THANH KHOA','120/5 CAO CHUONG','20/04/1993','0902444227')
INSERT INTO TACGIA(MATG,HOTEN,DIACHI,NGSINH,SODT) VALUES ('TG07','PHAM THANH CHUONG','164/7 CAO CHUONG','21/04/1993','0902444228')
INSERT INTO TACGIA(MATG,HOTEN,DIACHI,NGSINH,SODT) VALUES ('TG08','PHAM THANH HOANG','304/4 CAO CHUONG','22/04/1993','0902444229')
INSERT INTO TACGIA(MATG,HOTEN,DIACHI,NGSINH,SODT) VALUES ('TG09','PHAM THANH PHUC','159/4 CAO CHUONG','23/04/1993','0902410222')
INSERT INTO TACGIA(MATG,HOTEN,DIACHI,NGSINH,SODT) VALUES ('TG10','PHAM THANH NHAN','170/4 CAO CHUONG','24/04/1993','0902411222')


INSERT INTO SACH(MASACH,TENSACH,THELOAI) VALUES('S1','DACNHANTAM1','VANHOC')
INSERT INTO SACH(MASACH,TENSACH,THELOAI) VALUES('S2','DACNHANTAM2','TRUYENCUOI')
INSERT INTO SACH(MASACH,TENSACH,THELOAI) VALUES('S3','DACNHANTAM3','VANHOC')
INSERT INTO SACH(MASACH,TENSACH,THELOAI) VALUES('S4','DACNHANTAM4','GIAOKHOA')
INSERT INTO SACH(MASACH,TENSACH,THELOAI) VALUES('S5','DACNHANTAM5','VANHOC')
INSERT INTO SACH(MASACH,TENSACH,THELOAI) VALUES('S6','DACNHANTAM6','VANHOC')
INSERT INTO SACH(MASACH,TENSACH,THELOAI) VALUES('S7','DACNHANTAM7','CHUAHE')
INSERT INTO SACH(MASACH,TENSACH,THELOAI) VALUES('S8','DACNHANTAM8','VANHOC')
INSERT INTO SACH(MASACH,TENSACH,THELOAI) VALUES('S9','DACNHANTAM9','MANHKHOA')
INSERT INTO SACH(MASACH,TENSACH,THELOAI) VALUES('S10','DACNHANTAM10','VANHOC')
INSERT INTO SACH(MASACH,TENSACH,THELOAI) VALUES('S11','DACNHANTAM11','VANHOC')


INSERT INTO TACGIA_SACH(MATG,MASACH) VALUES('TG01','S1')
INSERT INTO TACGIA_SACH(MATG,MASACH) VALUES('TG02','S2')
INSERT INTO TACGIA_SACH(MATG,MASACH) VALUES('TG03','S3')
INSERT INTO TACGIA_SACH(MATG,MASACH) VALUES('TG04','S4')
INSERT INTO TACGIA_SACH(MATG,MASACH) VALUES('TG05','S5')
INSERT INTO TACGIA_SACH(MATG,MASACH) VALUES('TG06','S6')
INSERT INTO TACGIA_SACH(MATG,MASACH) VALUES('TG07','S7')
INSERT INTO TACGIA_SACH(MATG,MASACH) VALUES('TG08','S8')
INSERT INTO TACGIA_SACH(MATG,MASACH) VALUES('TG09','S9')
INSERT INTO TACGIA_SACH(MATG,MASACH) VALUES('TG10','S10')
INSERT INTO TACGIA_SACH(MATG,MASACH) VALUES('TG10','S11')


INSERT INTO PHATHANH(MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN) VALUES('PH1','S1','1/1/2020','100','TRE')
INSERT INTO PHATHANH(MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN) VALUES('PH2','S2','2/1/2020','100','TRE')
INSERT INTO PHATHANH(MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN) VALUES('PH3','S3','3/1/2020','110','TRE')
INSERT INTO PHATHANH(MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN) VALUES('PH4','S4','4/1/2020','130','TRE')
INSERT INTO PHATHANH(MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN) VALUES('PH5','S5','5/1/2020','150','GIA')
INSERT INTO PHATHANH(MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN) VALUES('PH6','S6','6/1/2020','200','TRE')
INSERT INTO PHATHANH(MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN) VALUES('PH7','S7','7/1/2020','100','TRE')
INSERT INTO PHATHANH(MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN) VALUES('PH8','S8','8/1/2020','101','GIA')
INSERT INTO PHATHANH(MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN) VALUES('PH9','S9','9/1/2020','109','TRE')
INSERT INTO PHATHANH(MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN) VALUES('PH10','S10','10/1/2020','100','DHQG')
INSERT INTO PHATHANH(MAPH,MASACH,NGAYPH,SOLUONG,NHAXUATBAN) VALUES('PH11','S11','10/1/2020','100','DHQG')

-- SQL
-- CAU3.1
SELECT TG.MATG,HOTEN,SODT
FROM TACGIA TG,TACGIA_SACH TGS, PHATHANH PH,SACH 
WHERE TG.MATG=TGS.MATG AND TGS.MASACH=PH.MASACH AND TGS.MASACH=SACH.MASACH AND NHAXUATBAN='TRE' AND THELOAI='VANHOC'

--CAU3.2
SELECT TOP (1) NHAXUATBAN, COUNT(DISTINCT SACH.THELOAI) AS TONG
FROM PHATHANH,SACH
WHERE PHATHANH.MASACH=SACH.MASACH
GROUP BY NHAXUATBAN
ORDER BY TONG DESC

--CAU3.3
SELECT NHAXUATBAN, TG.MATG, HOTEN, COUNT(MAPH) AS SOLANPH
FROM TACGIA TG,PHATHANH PH1,TACGIA_SACH TGS
WHERE TG.MATG=TGS.MATG  AND TGS.MASACH=PH1.MASACH
GROUP BY NHAXUATBAN,TG.MATG,HOTEN
HAVING COUNT(MAPH) >= ALL(
    
    SELECT COUNT(MAPH)
    FROM PHATHANH PH2,TACGIA_SACH TGS, TACGIA TG
    WHERE TGS.MATG=TG.MATG AND TGS.MASACH=PH2.MASACH
    GROUP BY NHAXUATBAN,TG.MATG
    HAVING PH1.NHAXUATBAN=PH2.NHAXUATBAN
)


